{"version":3,"names":[],"mappings":"","sources":["reche.js"],"sourcesContent":["!function(f){if(\"object\"==typeof exports&&\"undefined\"!=typeof module)module.exports=f();else if(\"function\"==typeof define&&define.amd)define([],f);else{(\"undefined\"!=typeof window?window:\"undefined\"!=typeof global?global:\"undefined\"!=typeof self?self:this).Reche=f()}}(function(){return function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c=\"function\"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error(\"Cannot find module '\"+i+\"'\");throw a.code=\"MODULE_NOT_FOUND\",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){return o(e[i][1][r]||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u=\"function\"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(_dereq_,module,exports){module.exports=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError(\"Cannot call a class as a function\")}},{}],2:[function(_dereq_,module,exports){function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,\"value\"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}module.exports=function(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}},{}],3:[function(_dereq_,module,exports){module.exports=function(obj){return obj&&obj.__esModule?obj:{default:obj}}},{}],4:[function(_dereq_,module,exports){function _typeof(obj){return\"function\"==typeof Symbol&&\"symbol\"==typeof Symbol.iterator?module.exports=_typeof=function(obj){return typeof obj}:module.exports=_typeof=function(obj){return obj&&\"function\"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?\"symbol\":typeof obj},_typeof(obj)}module.exports=_typeof},{}],5:[function(_dereq_,module,exports){\"use strict\";var _interopRequireDefault=_dereq_(\"@babel/runtime/helpers/interopRequireDefault\");Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/classCallCheck\")),_createClass2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/createClass\")),Event=function(){function Event(){(0,_classCallCheck2.default)(this,Event),this.event={},this.xhrEvent=[\"onloadstart\",\"onprogress\",\"onabort\",\"ontimeout\",\"onerror\",\"onload\",\"onloadend\",\"onreadystatechange\"],this.recheEvents=[\"fileStop\",\"fileResume\",\"fileCancel\",\"fileRestart\",\"fileRemove\",\"fileRemoveAll\",\"fileAppend\",\"fileCompleteAll\",\"fileProgress\",\"fileStatusChange\",\"fileError\"]}return(0,_createClass2.default)(Event,[{key:\"on\",value:function(name,callback){this.detectEventType(name)&&\"function\"==typeof callback&&(this.event[name]||(this.event[name]=[]),this.event[name].push(callback))}},{key:\"trigger\",value:function(name,info){if(this.event[name]&&this.event[name].length)for(var i=0;i<this.event[name].length;i++)this.event[name][i](info)}},{key:\"detectEventType\",value:function(name){return-1!==this.recheEvents.indexOf(name)?\"recheEvents\":-1!==this.xhrEvent.indexOf(name)?\"xhrEvent\":(console.error(\"Unknown event name: \".concat(name)),null)}}]),Event}();exports.default=Event},{\"@babel/runtime/helpers/classCallCheck\":1,\"@babel/runtime/helpers/createClass\":2,\"@babel/runtime/helpers/interopRequireDefault\":3}],6:[function(_dereq_,module,exports){\"use strict\";var _interopRequireDefault=_dereq_(\"@babel/runtime/helpers/interopRequireDefault\");Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/classCallCheck\")),_createClass2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/createClass\")),FileSlice=function(){function FileSlice(reche){(0,_classCallCheck2.default)(this,FileSlice),this.reche=reche}return(0,_createClass2.default)(FileSlice,[{key:\"fileSlice\",value:function(file,data){var fileId=this.reche.util.randomString(8),fileSliced={fileId:fileId,fileName:file.name,fileSize:file.size,file:null,data:data,resParam:null,status:this.reche.fileStatus.onWaiting,percent:0,fileChunk:[]};if(this.reche.option.chunkUse&&file.size>=this.reche.option.chunkUseSize)for(var index=0,start=0,end=0,chunkSize=this.reche.option.chunkSize,totalSlices=Math.ceil(file.size/chunkSize);index<totalSlices;){var chunkObj={fileChunkSize:0,fileId:fileId,index:0,chunk:null};end=(start=index*chunkSize)+chunkSize;var chunk=file.slice(start,end);index++,chunkObj.chunk=chunk,chunkObj.index=index,chunkObj.fileChunkSize=chunk.size,fileSliced.fileChunk.push(chunkObj)}else fileSliced.file=file;return fileSliced}}]),FileSlice}();exports.default=FileSlice},{\"@babel/runtime/helpers/classCallCheck\":1,\"@babel/runtime/helpers/createClass\":2,\"@babel/runtime/helpers/interopRequireDefault\":3}],7:[function(_dereq_,module,exports){\"use strict\";var _interopRequireDefault=_dereq_(\"@babel/runtime/helpers/interopRequireDefault\");Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/classCallCheck\")),_createClass2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/createClass\")),I18n=function(){function I18n(lang){(0,_classCallCheck2.default)(this,I18n),this.lang=lang,this.txt={\"zh-cn\":{unSupportXhr:\"您的浏览器不支持XHR请求\",cannotStopByProgress:\"正在创建文件不能暂停\",cannotStopByUploaded:\"文件已上传完成不能暂停\",cannotStop:\"当前文件状态不能暂停\"}}}return(0,_createClass2.default)(I18n,[{key:\"i18n\",value:function(name){return this.txt[this.lang]&&this.txt[this.lang][name]?this.txt[this.lang][name]:name}}]),I18n}();exports.default=I18n},{\"@babel/runtime/helpers/classCallCheck\":1,\"@babel/runtime/helpers/createClass\":2,\"@babel/runtime/helpers/interopRequireDefault\":3}],8:[function(_dereq_,module,exports){\"use strict\";var _interopRequireDefault=_dereq_(\"@babel/runtime/helpers/interopRequireDefault\");Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/classCallCheck\")),_createClass2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/createClass\")),Option=function(){function Option(){(0,_classCallCheck2.default)(this,Option),this.defaultOption={chunkUse:!0,chunkSize:5<<20,chunkUseSize:10<<20,path:\"\",chunkPath:\"\",timeout:36e5,chunkThreadNumber:5,chunkFirstResParamKey:{},lang:\"zh-cn\",async:!0,headers:{},fdKey:{}}}return(0,_createClass2.default)(Option,[{key:\"optionInit\",value:function(option){for(var item in this.defaultOption)this.defaultOption.hasOwnProperty(item)&&!option.hasOwnProperty(item)&&(option[item]=this.defaultOption[item]);var fdKey={fileKey:\"file\",chunkKey:\"chunk\",chunksKey:\"chunks\",indexKey:\"index\",fileNameKey:\"fileName\"},chunkFirstResParamKey={uploadId:\"uploadId\",fileName:\"fileName\"};if(option.fdKey)for(var _item in fdKey)option.fdKey[_item]=option.fdKey[_item]?option.fdKey[_item]:fdKey[_item];else option.fdKey=fdKey;if(option.chunkFirstResParamKey)for(var _item2 in chunkFirstResParamKey)option.chunkFirstResParamKey[_item2]=option.chunkFirstResParamKey[_item2]?option.chunkFirstResParamKey[_item2]:chunkFirstResParamKey[_item2];else option.chunkFirstResParamKey=chunkFirstResParamKey;return option}}]),Option}();exports.default=Option},{\"@babel/runtime/helpers/classCallCheck\":1,\"@babel/runtime/helpers/createClass\":2,\"@babel/runtime/helpers/interopRequireDefault\":3}],9:[function(_dereq_,module,exports){\"use strict\";var _interopRequireDefault=_dereq_(\"@babel/runtime/helpers/interopRequireDefault\");Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/classCallCheck\")),_createClass2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/createClass\")),Queue=function(){function Queue(reche){(0,_classCallCheck2.default)(this,Queue),this.reche=reche,this.fileStoppedId=[],this.queue={fileChunkOnWaiting:[],fileChunkOnProgress:[],fileChunkOnCompleted:[]}}return(0,_createClass2.default)(Queue,[{key:\"deleteChunkOfQueue\",value:function(fileId){for(var item in this.queue){for(var tempObj=[],i=0;i<this.queue[item].length;i++)this.queue[item][i].fileId!==fileId&&tempObj.push(Object.assign({},this.queue[item][i]));this.queue[item]=tempObj}}},{key:\"preposition\",value:function(queueName,fileId){for(var tempArr=[],otherThisArr=[],i=0;i<this.queue[queueName].length;i++){var aObj=Object.assign({},this.queue[queueName][i]);this.queue[queueName][i].fileId===fileId?tempArr.push(aObj):otherThisArr.push(aObj)}this.queue[queueName]=tempArr.concat(otherThisArr)}},{key:\"resetChunkQueue\",value:function(){this.queue={fileChunkOnWaiting:[],fileChunkOnProgress:[],fileChunkOnCompleted:[]}}},{key:\"removeFileChunk\",value:function(argument_0){var fileId=0<arguments.length&&void 0!==argument_0?argument_0:null;fileId?this.deleteChunkOfQueue(fileId):this.resetChunkQueue(),this.reche.abortAndRemoveXhr(fileId)}},{key:\"appendFileChunkQueue\",value:function(fileSliced){fileSliced.file&&!fileSliced.fileChunk.length?this.queue.fileChunkOnWaiting.push({fileId:fileSliced.fileId,index:-1,fileChunkSize:fileSliced.fileSize,chunk:fileSliced.file,data:fileSliced.data}):this.queue.fileChunkOnWaiting=this.queue.fileChunkOnWaiting.concat(fileSliced.fileChunk)}},{key:\"dispatch\",value:function(){var index=0,kIndex=-1;if(this.fileStoppedId.length)for(var k=0;k<this.queue.fileChunkOnWaiting.length;k++){for(var tag=!0,i=0;i<this.fileStoppedId.length;i++)if(this.fileStoppedId[i]===this.queue.fileChunkOnWaiting[k].fileId){tag=!tag;break}if(tag){index=k;break}kIndex=k}if(kIndex===this.queue.fileChunkOnWaiting.length-1)return!1;if(this.queue.fileChunkOnWaiting.length){var fChunk=this.queue.fileChunkOnWaiting.splice(index,1)[0];return this.queue.fileChunkOnProgress.push(fChunk),fChunk}console.warn(\"no fileChunk in fileChunkOnWaiting\")}},{key:\"formProgressToCompleted\",value:function(chunk){for(var i=0;i<this.queue.fileChunkOnProgress.length;i++)if(chunk.fileId===this.queue.fileChunkOnProgress[i].fileId&&chunk.index===this.queue.fileChunkOnProgress[i].index){var fChunk=this.queue.fileChunkOnProgress.splice(i,1)[0];return this.queue.fileChunkOnCompleted.push(fChunk),fChunk}}},{key:\"forProgressToError\",value:function(){}},{key:\"formWaitingToStopped\",value:function(){}},{key:\"formStoppedToWaiting\",value:function(){}},{key:\"isComplete\",value:function(fileId){for(var tag=0,i=0;i<this.queue.fileChunkOnCompleted.length;i++)this.queue.fileChunkOnCompleted[i].fileId===fileId&&(tag+=1);return tag===this.reche.fileMap[fileId].fileChunk.length}},{key:\"isCompleteAll\",value:function(){var statusAllComplete=!0;for(var item in this.reche.fileMap)if(this.reche.fileMap[item].status!==this.reche.fileStatus.onCompleted){statusAllComplete=!1;break}return 0===this.queue.fileChunkOnWaiting.length&&0===this.queue.fileChunkOnProgress.length&&0===this.reche.xhrList.length&&statusAllComplete}}]),Queue}();exports.default=Queue},{\"@babel/runtime/helpers/classCallCheck\":1,\"@babel/runtime/helpers/createClass\":2,\"@babel/runtime/helpers/interopRequireDefault\":3}],10:[function(_dereq_,module,exports){\"use strict\";var _interopRequireDefault=_dereq_(\"@babel/runtime/helpers/interopRequireDefault\");Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/classCallCheck\")),_createClass2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/createClass\")),_Util=_interopRequireDefault(_dereq_(\"./Util\")),_Xhr=_interopRequireDefault(_dereq_(\"./Xhr\")),_Event=_interopRequireDefault(_dereq_(\"./Event\")),_I18n=_interopRequireDefault(_dereq_(\"./I18n\")),_Option=_interopRequireDefault(_dereq_(\"./Option\")),_Queue=_interopRequireDefault(_dereq_(\"./Queue\")),_FileSlice=_interopRequireDefault(_dereq_(\"./FileSlice\")),Reche=function(){function Reche(option){(0,_classCallCheck2.default)(this,Reche),this.fileMap={},this.util=new _Util.default(this),this.option=(new _Option.default).optionInit(option),this.event=new _Event.default,this.i18n=new _I18n.default(this.option.lang),this.queue=new _Queue.default(this),this.fileSlice=new _FileSlice.default(this),this.fileStatus={onWaiting:0,onProgress:1,onCompleted:2,onStopped:3,onError:4,onCanceled:5},this.xhrList=[]}return(0,_createClass2.default)(Reche,[{key:\"reche\",value:function(option){var files=option.files,data=this.util.isObject(option.data)?option.data:null;if(files.length){for(var i=0;i<files.length;i++){var fileSliced=this.fileSlice.fileSlice(files[i],data);this.fileMap[fileSliced.fileId]=fileSliced,this.queue.appendFileChunkQueue(fileSliced),this.event.trigger(\"fileAppend\",{event:\"event:::fileAppend\",file:files,fileMap:this.fileMap}),this.event.trigger(\"fileStatusChange\",{event:\"event:::fileStatusChange\",fileId:fileSliced.fileId,status:this.fileStatus.onWaiting})}this.exeXhr()}}},{key:\"exeXhr\",value:function(){if(0===this.xhrList.length&&this.queue.queue.fileChunkOnWaiting.length){var fc=this.queue.dispatch();if(fc){var xhr=new _Xhr.default(this);this.xhrList.push(xhr),xhr.sendXhr(fc)}}}},{key:\"abortAndRemoveXhr\",value:function(argument_0){var fileId=0<arguments.length&&void 0!==argument_0?argument_0:null;if(fileId){for(var i=0;i<this.xhrList.length;i++)if(fileId===this.xhrList[i].fileOrChunk.fileId)return this.xhrList[i].abortXhr(),void this.xhrList.splice(i,1)}else for(var _i=0;_i<this.xhrList.length;_i++)this.xhrList[_i].abortXhr(),this.xhrList=[]}},{key:\"remove\",value:function(fileId){this.fileMap[fileId]&&(this.fileMap[fileId].status!==this.fileStatus.onCanceled&&this.fileMap[fileId].status!==this.fileStatus.onCompleted&&this.fileMap[fileId].status!==this.fileStatus.onError||(delete this.fileMap[fileId],this.queue.removeFileChunk(fileId),this.abortAndRemoveXhr(fileId),this.event.trigger(\"fileRemove\",{event:\"event:::fileRemove\",fileId:fileId})))}},{key:\"stop\",value:function(fileId){this.fileMap[fileId]&&(this.fileMap[fileId].file?this.event.trigger(\"fileStop\",{event:\"event:::fileStop\",fileId:fileId,canStop:!1,message:this.i18n.i18n(\"cannotStopByProgress\")}):this.fileMap[fileId].status===this.fileStatus.onWaiting||this.fileMap[fileId].status===this.fileStatus.onProgress?(this.queue.fileStoppedId.push(fileId),this.fileMap[fileId].status=this.fileStatus.onStopped,this.event.trigger(\"fileStop\",{event:\"event:::fileStop\",fileId:fileId}),this.event.trigger(\"fileStatusChange\",{event:\"event:::fileStatusChange\",fileId:fileId,status:this.fileStatus.onStopped})):this.event.trigger(\"fileStop\",{event:\"event:::fileStop\",fileId:fileId,canStop:!1,message:this.i18n.i18n(\"cannotStop\")}))}},{key:\"changeFileStatus\",value:function(argument_0,argument_1,argument_2,argument_3){var fileId=0<arguments.length&&void 0!==argument_0?argument_0:null,excludeFileId=1<arguments.length&&void 0!==argument_1?argument_1:null,formStatus=2<arguments.length?argument_2:void 0,toStatus=3<arguments.length?argument_3:void 0;if(fileId)this.fileMap[fileId].status!==toStatus&&(this.fileMap[fileId].status=toStatus,this.event.trigger(\"fileStatusChange\",{event:\"event:::fileStatusChange\",fileId:fileId,status:toStatus}));else for(var item in this.fileMap)item!==excludeFileId&&this.fileMap[item].status===formStatus&&(this.fileMap[item].status=toStatus,this.event.trigger(\"fileStatusChange\",{event:\"event:::fileStatusChange\",fileId:fileId,status:toStatus}))}},{key:\"removeFileIdFormStoppedId\",value:function(fileId){for(var i=0;i<this.queue.fileStoppedId.length;i++)if(fileId===this.queue.fileStoppedId[i]){this.queue.fileStoppedId.splice(i,1);break}}},{key:\"resume\",value:function(fileId){this.fileMap[fileId]&&this.fileMap[fileId].status===this.fileStatus.onStopped&&(console.log(this.queue.queue.fileChunkOnProgress),0===this.queue.queue.fileChunkOnProgress.length&&(this.changeFileStatus(null,fileId,this.fileStatus.onProgress,this.fileStatus.onWaiting),this.removeFileIdFormStoppedId(fileId),this.abortAndRemoveXhr(fileId),this.queue.preposition(\"fileChunkOnWaiting\",fileId),this.event.trigger(\"fileResume\",{event:\"event:::fileResume\",fileId:fileId}),this.exeXhr()))}},{key:\"restart\",value:function(fileId){this.fileMap[fileId]&&(this.fileMap[fileId].status!==this.fileStatus.onCanceled&&this.fileMap[fileId].status!==this.fileStatus.onError||(this.changeFileStatus(fileId,null,null,this.fileStatus.onWaiting),this.queue.appendFileChunkQueue(this.fileMap[fileId]),this.event.trigger(\"fileRestart\",{event:\"event:::fileRestart\",fileId:fileId}),this.exeXhr()))}},{key:\"cancel\",value:function(fileId){this.fileMap[fileId]&&(this.fileMap[fileId].status!==this.fileStatus.onWaiting&&this.fileMap[fileId].status!==this.fileStatus.onStopped&&this.fileMap[fileId].status!==this.fileStatus.onProgress||(this.removeFileIdFormStoppedId(fileId),this.changeFileStatus(fileId,null,null,this.fileStatus.onCanceled),this.abortAndRemoveXhr(fileId),this.queue.removeFileChunk(fileId),this.event.trigger(\"fileCancel\",{event:\"event:::fileCancel\",fileId:fileId}),this.fileMap[fileId].progress=0,this.event.trigger(\"fileProgress\",{event:\"event:::fileProgress\",fileId:fileId,progress:0})))}},{key:\"on\",value:function(name,callback){return this.event.on(name,callback),this}}]),Reche}();Object.defineProperty(Reche,\"version\",{enumerable:!0,get:function(){return\"0.0.4\"}});var _default=Reche;exports.default=_default},{\"./Event\":5,\"./FileSlice\":6,\"./I18n\":7,\"./Option\":8,\"./Queue\":9,\"./Util\":11,\"./Xhr\":12,\"@babel/runtime/helpers/classCallCheck\":1,\"@babel/runtime/helpers/createClass\":2,\"@babel/runtime/helpers/interopRequireDefault\":3}],11:[function(_dereq_,module,exports){\"use strict\";var _interopRequireDefault=_dereq_(\"@babel/runtime/helpers/interopRequireDefault\");Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var _typeof2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/typeof\")),_classCallCheck2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/classCallCheck\")),_createClass2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/createClass\")),Util=function(){function Util(reche){(0,_classCallCheck2.default)(this,Util),this.reche=reche,this.fileStatus={onWaiting:0,onProgress:1,onStopped:2,onCompleted:3,onError:4,onCanceled:5}}return(0,_createClass2.default)(Util,[{key:\"isNull\",value:function(val){return null===val}},{key:\"isNullString\",value:function(val){return\"\"===val}},{key:\"isObject\",value:function(val){return null!==val&&\"object\"===(0,_typeof2.default)(val)&&val.constructor===Object}},{key:\"isUndefined\",value:function(val){return void 0===val}},{key:\"isNumber\",value:function(val){return\"number\"==typeof val}},{key:\"isString\",value:function(val){return\"string\"==typeof val}},{key:\"isBoolean\",value:function(val){return!0===val||!1===val}},{key:\"isTrue\",value:function(val){return!0===val}},{key:\"randomString\",value:function(len){for(var str=\"\",range=len,arr=[\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"a\",\"b\",\"c\",\"d\",\"e\",\"f\",\"g\",\"h\",\"i\",\"j\",\"k\",\"l\",\"m\",\"n\",\"o\",\"p\",\"q\",\"r\",\"s\",\"t\",\"u\",\"v\",\"w\",\"x\",\"y\",\"z\",\"A\",\"B\",\"C\",\"D\",\"E\",\"F\",\"G\",\"H\",\"I\",\"J\",\"K\",\"L\",\"M\",\"N\",\"O\",\"P\",\"Q\",\"R\",\"S\",\"T\",\"U\",\"V\",\"W\",\"X\",\"Y\",\"Z\"],i=0;i<range;i++){str+=arr[Math.round(Math.random()*(arr.length-1))]}if(!this.reche.fileMap[str])return str;this.randomString(len)}},{key:\"isFalse\",value:function(val){return!1===val}},{key:\"isArray\",value:function(val){return val instanceof Array}}]),Util}();exports.default=Util},{\"@babel/runtime/helpers/classCallCheck\":1,\"@babel/runtime/helpers/createClass\":2,\"@babel/runtime/helpers/interopRequireDefault\":3,\"@babel/runtime/helpers/typeof\":4}],12:[function(_dereq_,module,exports){\"use strict\";var _interopRequireDefault=_dereq_(\"@babel/runtime/helpers/interopRequireDefault\");Object.defineProperty(exports,\"__esModule\",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/classCallCheck\")),_createClass2=_interopRequireDefault(_dereq_(\"@babel/runtime/helpers/createClass\")),Xhr=function(){function Xhr(reche){(0,_classCallCheck2.default)(this,Xhr),this.reche=reche,this.xhr=this.initXhr(),this.progress=0,this.fileOrChunk=null}return(0,_createClass2.default)(Xhr,[{key:\"initXhr\",value:function(){var _this=this,xhr=null;if(window.XMLHttpRequest)xhr=new XMLHttpRequest;else{if(!window.ActiveXObject)return console.warn(this.reche.i18n.i18n(\"unSupportXhr\")),xhr;xhr=new ActiveXObject(\"Microsoft.XMLHTTP\")}return this.reche.option.async&&(xhr.timeout=this.reche.option.timeout,xhr.upload.ontimeout=function(e){_this.xhrError(_this.fileOrChunk.fileId,xhr)}),xhr.upload.onprogress=function(e){var progress=0;if(e.lengthComputable)if(_this.progress=e.loaded/e.total,-1===_this.fileOrChunk.index)progress=e.loaded/e.total;else{for(var totalUpSize=0,i=0;i<_this.reche.xhrList.length;i++)totalUpSize+=_this.reche.xhrList[i].fileOrChunk.fileChunkSize*_this.progress;for(var n=0;n<_this.reche.queue.queue.fileChunkOnCompleted.length;n++)_this.fileOrChunk.fileId===_this.reche.queue.queue.fileChunkOnCompleted[n].fileId&&(totalUpSize+=_this.reche.queue.queue.fileChunkOnCompleted[n].fileChunkSize);progress=totalUpSize/_this.reche.fileMap[_this.fileOrChunk.fileId].fileSize}_this.reche.fileMap[_this.fileOrChunk.fileId].progress=progress,_this.reche.event.trigger(\"fileProgress\",{event:\"event:::fileProgress\",fileId:_this.fileOrChunk.fileId,progress:progress})},xhr.upload.onerror=function(e){_this.xhrError(_this.fileOrChunk.fileId,xhr)},xhr.onreadystatechange=function(){if(4===xhr.readyState)if(200===xhr.status){var resJson=JSON.parse(xhr.response);if(200===Number(resJson.status)){var fileOfMap=_this.reche.fileMap[_this.fileOrChunk.fileId];if(console.log(\"当前文件总块数：\"+fileOfMap.fileChunk.length+\"----已完成完成块数：\"+_this.fileOrChunk.index),_this.reche.queue.formProgressToCompleted(_this.fileOrChunk),-1===_this.fileOrChunk.index)_this.reche.changeFileStatus(_this.fileOrChunk.fileId,null,null,_this.reche.fileStatus.onCompleted);else{if(1===_this.fileOrChunk.index){var resParam={},cusfrpk=_this.reche.option.chunkFirstResParamKey;if(resJson.data){for(var item in cusfrpk)resParam[cusfrpk[item]]=resJson.data[cusfrpk[item]];_this.reche.fileMap[_this.fileOrChunk.fileId].resParam=resParam}}_this.reche.queue.isComplete(_this.fileOrChunk.fileId)&&_this.reche.changeFileStatus(_this.fileOrChunk.fileId,null,null,_this.reche.fileStatus.onCompleted)}_this.reche.abortAndRemoveXhr(_this.fileOrChunk.fileId),_this.reche.queue.isCompleteAll()?_this.reche.event.trigger(\"fileCompleteAll\",{event:\"event:::fileCompleteAll\",response:xhr.response}):_this.reche.exeXhr()}else console.log(resJson),_this.xhrError(_this.fileOrChunk.fileId,xhr)}else _this.xhrError(_this.fileOrChunk.fileId,xhr)},xhr}},{key:\"sendXhr\",value:function(fileOrChunk){if(this.fileOrChunk=fileOrChunk,this.xhr){var fd=this.buildFormData(fileOrChunk);this.reche.fileMap[fileOrChunk.fileId].status!==this.reche.fileStatus.onProgress&&this.reche.changeFileStatus(this.fileOrChunk.fileId,null,null,this.reche.fileStatus.onProgress);var path=-1===this.fileOrChunk.index?this.reche.option.path:this.reche.option.chunkPath;this.xhr.open(\"POST\",path,this.reche.option.async),this.setXhrHeader(this.xhr,this.reche.option.headers),this.xhr.send(fd)}}},{key:\"xhrError\",value:function(fileId,xhr){this.reche.abortAndRemoveXhr(fileId),this.reche.queue.deleteChunkOfQueue(fileId),this.reche.changeFileStatus(fileId,null,null,this.reche.fileStatus.onError),this.reche.event.trigger(\"fileError\",{event:\"event:::fileError\",fileId:fileId,xhr:xhr})}},{key:\"buildFormData\",value:function(fileOrChunk){var formData=new FormData;formData.append(this.reche.option.fdKey.fileKey,fileOrChunk.chunk),formData.append(this.reche.option.fdKey.chunkKey,fileOrChunk.index),formData.append(this.reche.option.fdKey.chunksKey,this.reche.fileMap[fileOrChunk.fileId].fileChunk.length.toString());var resParam=this.reche.fileMap[fileOrChunk.fileId].resParam;if(resParam||formData.append(this.reche.option.fdKey.fileNameKey,this.reche.fileMap[fileOrChunk.fileId].fileName),resParam)for(var item in resParam)formData.append(item,resParam[item]);if(this.reche.util.isObject(fileOrChunk.data)&&\"{}\"!==fileOrChunk.data.toString())for(var _item in fileOrChunk.data)formData.append(_item,fileOrChunk.data[_item]);return formData}},{key:\"abortXhr\",value:function(){this.xhr&&(this.xhr=null)}},{key:\"setXhrHeader\",value:function(xhr,headers){if(this.reche.util.isObject(headers)&&\"{}\"!==headers.toString())for(var item in headers)xhr.setRequestHeader(item,headers[item])}}]),Xhr}();exports.default=Xhr},{\"@babel/runtime/helpers/classCallCheck\":1,\"@babel/runtime/helpers/createClass\":2,\"@babel/runtime/helpers/interopRequireDefault\":3}],13:[function(_dereq_,module,exports){\"use strict\";module.exports=_dereq_(\"./core/Reche\").default},{\"./core/Reche\":10}]},{},[13])(13)});"],"file":"reche.js"}